# SSH Keep Alive æ›´æ–°

**æ›´æ–°æ—¶é—´**: 2026-02-12 00:55 PST  
**æ›´æ–°å†…å®¹**: ä¸ºæ‰€æœ‰ SSH ControlMaster è¿æ¥æ·»åŠ  Keep Alive æ”¯æŒ

---

## ğŸ¯ æ›´æ–°ç›®çš„

é˜²æ­¢ SSH ControlMaster è¿æ¥å› ç©ºé—²è€Œè¢«æœåŠ¡å™¨æ–­å¼€ï¼Œæé«˜è¿æ¥ç¨³å®šæ€§ã€‚

---

## ğŸ“ æ›´æ–°å†…å®¹

### 1. cm-session.py (SSH Mode)

**ä½ç½®**: ç¬¬ 267-271 è¡Œ

**ä¿®æ”¹å‰**:
```python
master_cmd = [
    'ssh', '-fN', '-M',
    '-S', control_path,
    '-o', 'ControlPersist=10m',
    '-p', str(port),
    f'{user}@{host}'
]
```

**ä¿®æ”¹å**:
```python
master_cmd = [
    'ssh', '-fN', '-M',
    '-S', control_path,
    '-o', 'ControlPersist=10m',
    '-o', 'ServerAliveInterval=60',    # â† æ–°å¢
    '-o', 'ServerAliveCountMax=3',     # â† æ–°å¢
    '-p', str(port),
    f'{user}@{host}'
]
```

**è¾“å‡ºå˜åŒ–**:
```
ä¿®æ”¹å‰: âœ… Master connection established
ä¿®æ”¹å: âœ… Master connection established (with keep-alive)
```

---

### 2. cm-ssh-persistent.py (Persistent Connection)

**ä½ç½®**: ç¬¬ 34-40 è¡Œ

**ä¿®æ”¹å‰**:
```python
master_cmd = [
    'ssh',
    '-fN', '-M',
    '-S', self.control_path,
    '-o', 'ControlPersist=10m',
    '-p', str(self.port),
    f'{self.user}@{self.host}'
]
```

**ä¿®æ”¹å**:
```python
master_cmd = [
    'ssh',
    '-fN', '-M',
    '-S', self.control_path,
    '-o', 'ControlPersist=10m',
    '-o', 'ServerAliveInterval=60',    # â† æ–°å¢
    '-o', 'ServerAliveCountMax=3',     # â† æ–°å¢
    '-p', str(self.port),
    f'{self.user}@{self.host}'
]
```

**è¾“å‡ºå˜åŒ–**:
```
ä¿®æ”¹å‰: âœ… SSH ControlMaster established
ä¿®æ”¹å: âœ… SSH ControlMaster established (with keep-alive)
```

---

## âš™ï¸ Keep Alive å‚æ•°è¯´æ˜

### ServerAliveInterval=60

**å«ä¹‰**: æ¯ 60 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³åŒ…

**ä½œç”¨**:
- ä¿æŒè¿æ¥æ´»è·ƒ
- é˜²æ­¢æœåŠ¡å™¨å› ç©ºé—²æ–­å¼€è¿æ¥
- æ£€æµ‹è¿æ¥æ˜¯å¦ä»ç„¶æœ‰æ•ˆ

**æµé‡**: 
- æ¯æ¬¡å¿ƒè·³: ~100 bytes
- æ¯å°æ—¶: ~6 KB
- æ¯å¤©: ~140 KB
- **éå¸¸è½»é‡** âœ…

---

### ServerAliveCountMax=3

**å«ä¹‰**: å…è®¸è¿ç»­ 3 æ¬¡å¿ƒè·³å¤±è´¥

**ä½œç”¨**:
- å¿ƒè·³å¤±è´¥ 1 æ¬¡: ç»§ç»­å°è¯•
- å¿ƒè·³å¤±è´¥ 2 æ¬¡: ç»§ç»­å°è¯•
- å¿ƒè·³å¤±è´¥ 3 æ¬¡: æ–­å¼€è¿æ¥

**æ£€æµ‹æ—¶é—´**:
```
å¤±è´¥ 1: 60ç§’
å¤±è´¥ 2: 120ç§’
å¤±è´¥ 3: 180ç§’
â†’ çº¦ 3 åˆ†é’Ÿå†…æ£€æµ‹åˆ°è¿æ¥æ–­å¼€
```

**å¥½å¤„**:
- å®¹å¿çŸ­æš‚çš„ç½‘ç»œæ³¢åŠ¨
- é¿å…è¯¯åˆ¤
- å¿«é€Ÿæ£€æµ‹çœŸæ­£çš„æ–­çº¿

---

## ğŸ“Š æ•ˆæœå¯¹æ¯”

### ä¿®æ”¹å‰ï¼ˆæ—  Keep Aliveï¼‰

```
SSH ControlMaster å»ºç«‹
â†“
[ç©ºé—² 5-10 åˆ†é’Ÿ]
â†“
æœåŠ¡å™¨è¶…æ—¶æ£€æŸ¥:
  "æ²¡æœ‰æ•°æ®ï¼Œå¯èƒ½æ–­äº†"
â†“
âŒ æœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€è¿æ¥
â†“
ä¸‹æ¬¡ä½¿ç”¨: è¿æ¥å¤±è´¥
éœ€è¦é‡æ–°å»ºç«‹ ControlMaster
```

**é—®é¢˜**:
- âŒ è¿æ¥å®¹æ˜“æ–­å¼€
- âŒ éœ€è¦é¢‘ç¹é‡è¿
- âŒ å½±å“ç”¨æˆ·ä½“éªŒ

---

### ä¿®æ”¹åï¼ˆæœ‰ Keep Aliveï¼‰

```
SSH ControlMaster å»ºç«‹
â†“
[ç©ºé—²æœŸé—´]
  æ¯ 60 ç§’: å‘é€å¿ƒè·³ âœ…
  æœåŠ¡å™¨: "æœ‰æ´»åŠ¨ï¼Œä¿æŒè¿æ¥"
â†“
âœ… è¿æ¥ä¿æŒç¨³å®š
â†“
10 åˆ†é’Ÿå: ControlPersist åˆ°æœŸ
è‡ªåŠ¨å…³é—­ï¼ˆæ­£å¸¸è¡Œä¸ºï¼‰
```

**ä¼˜åŠ¿**:
- âœ… è¿æ¥æ›´ç¨³å®š
- âœ… å‡å°‘é‡è¿æ¬¡æ•°
- âœ… æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- âœ… æµé‡å¼€é”€æå°

---

## ğŸ”„ å‘åå…¼å®¹æ€§

### å®Œå…¨å…¼å®¹ âœ…

**ä¸å½±å“**:
- ç°æœ‰åŠŸèƒ½
- ç°æœ‰å‘½ä»¤
- ç°æœ‰é…ç½®
- ç°æœ‰ sessions

**ä»…æ”¹è¿›**:
- è¿æ¥ç¨³å®šæ€§
- é”™è¯¯æ¢å¤èƒ½åŠ›

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### æµ‹è¯• 1: æ£€æŸ¥å‚æ•°æ˜¯å¦ç”Ÿæ•ˆ

```bash
# å¯åŠ¨ä¸€ä¸ª SSH session
cd /home/hren/.openclaw/workspace/cm-prototype
python3 cm-cli.py start claude "test keep-alive" --ctx test-remote

# æŸ¥çœ‹è¾“å‡º
æœŸæœ›çœ‹åˆ°:
âœ… Master connection established (with keep-alive)
```

### æµ‹è¯• 2: éªŒè¯å¿ƒè·³åŒ…

```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯ç›‘æ§ SSH è¿æ¥
watch -n 5 'ss -tn | grep :3859'

# åº”è¯¥çœ‹åˆ°:
# - è¿æ¥ä¿æŒ ESTABLISHED
# - Send-Q/Recv-Q å®šæœŸæœ‰å°çš„å˜åŒ–ï¼ˆå¿ƒè·³åŒ…ï¼‰
```

### æµ‹è¯• 3: ç©ºé—²æµ‹è¯•

```bash
# 1. å»ºç«‹è¿æ¥
python3 cm-cli.py start claude "idle test" --ctx test-remote

# 2. ç­‰å¾… 10 åˆ†é’Ÿï¼ˆä¸æ“ä½œï¼‰

# 3. æ£€æŸ¥ ControlMaster
ps aux | grep ControlMaster | grep -v grep

# æœŸæœ›:
# - 10 åˆ†é’Ÿå†…: âœ… Master ä»åœ¨è¿è¡Œ
# - è¶…è¿‡ 10 åˆ†é’Ÿ: âŒ Master è‡ªåŠ¨å…³é—­ï¼ˆControlPersistï¼‰
```

---

## ğŸ“ˆ æ€§èƒ½å½±å“

### ç½‘ç»œæµé‡

```
å¿ƒè·³é¢‘ç‡: 60 ç§’/æ¬¡
å¿ƒè·³å¤§å°: ~100 bytes
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ¯å°æ—¶: 60 Ã— 100 = 6 KB
æ¯å¤©: 24 Ã— 6 = 144 KB
æ¯æœˆ: 30 Ã— 144 = 4.3 MB
```

**ç»“è®º**: **å‡ ä¹å¯ä»¥å¿½ç•¥** âœ…

---

### CPU å¼€é”€

```
å¿ƒè·³æ“ä½œ:
  - å‘é€: å¾®ç§’çº§
  - å¤„ç†: å¾®ç§’çº§
  
CPU ä½¿ç”¨ç‡å¢åŠ : < 0.01%
```

**ç»“è®º**: **å®Œå…¨å¯å¿½ç•¥** âœ…

---

### å†…å­˜å¼€é”€

```
é¢å¤–å†…å­˜: 0 bytes
(ä½¿ç”¨ç°æœ‰ SSH è¿æ¥ï¼Œä¸éœ€è¦é¢å¤–å†…å­˜)
```

**ç»“è®º**: **æ— å½±å“** âœ…

---

## ğŸ¯ é€‚ç”¨åœºæ™¯

### éå¸¸é€‚åˆ

âœ… **ä¸ç¨³å®šç½‘ç»œ**
- WiFi ç¯å¢ƒ
- ç§»åŠ¨ç½‘ç»œ
- VPN è¿æ¥

âœ… **é•¿æ—¶é—´ç©ºé—²**
- é—´æ­‡æ€§ä½¿ç”¨
- åå°ä»»åŠ¡
- ç›‘æ§åœºæ™¯

âœ… **ä¸¥æ ¼çš„æœåŠ¡å™¨è¶…æ—¶ç­–ç•¥**
- çŸ­è¶…æ—¶æ—¶é—´ï¼ˆ< 5 åˆ†é’Ÿï¼‰
- å®‰å…¨æ€§è¦æ±‚é«˜çš„ç¯å¢ƒ

---

### ä¸å¤ªé‡è¦

âš ï¸ **éå¸¸ç¨³å®šçš„ç½‘ç»œ**
- å†…ç½‘æœ‰çº¿è¿æ¥
- æ•°æ®ä¸­å¿ƒå†…éƒ¨

âš ï¸ **é¢‘ç¹ä½¿ç”¨**
- æŒç»­æ•°æ®ä¼ è¾“
- å®æ—¶äº¤äº’

**è¯´æ˜**: è¿™äº›åœºæ™¯ä¹Ÿä¸ä¼šæœ‰è´Ÿé¢å½±å“ï¼Œåªæ˜¯æ”¶ç›Šè¾ƒå°ã€‚

---

## ğŸ”§ è‡ªå®šä¹‰é…ç½®

### å¦‚æœéœ€è¦è°ƒæ•´å‚æ•°

#### æ›´é¢‘ç¹çš„å¿ƒè·³ï¼ˆä¸ç¨³å®šç½‘ç»œï¼‰

```python
'-o', 'ServerAliveInterval=30',   # 30ç§’
'-o', 'ServerAliveCountMax=5',    # 5æ¬¡
```

#### æ›´ç¨€ç–çš„å¿ƒè·³ï¼ˆç¨³å®šç½‘ç»œï¼‰

```python
'-o', 'ServerAliveInterval=120',  # 120ç§’ï¼ˆ2åˆ†é’Ÿï¼‰
'-o', 'ServerAliveCountMax=2',    # 2æ¬¡
```

#### ç¦ç”¨ Keep Aliveï¼ˆä¸æ¨èï¼‰

```python
# åˆ é™¤è¿™ä¸¤è¡Œ
# '-o', 'ServerAliveInterval=60',
# '-o', 'ServerAliveCountMax=3',
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### SSH é…ç½®æ–‡ä»¶æ–¹å¼

å¦‚æœæƒ³å…¨å±€é…ç½®ï¼ˆæ‰€æœ‰ SSH è¿æ¥ï¼‰:

```bash
# ~/.ssh/config
Host *
    ServerAliveInterval 60
    ServerAliveCountMax 3
```

### æœåŠ¡å™¨ç«¯é…ç½®

æœåŠ¡å™¨ç®¡ç†å‘˜å¯ä»¥è®¾ç½®å®¢æˆ·ç«¯è¶…æ—¶:

```bash
# /etc/ssh/sshd_config
ClientAliveInterval 300
ClientAliveCountMax 0
```

**æ³¨æ„**: å®¢æˆ·ç«¯ Keep Alive ä¼˜å…ˆçº§æ›´é«˜ï¼

---

## ğŸŠ æ€»ç»“

### æ›´æ–°å†…å®¹

âœ… **cm-session.py** - SSH Mode å¯åŠ¨æ·»åŠ  Keep Alive  
âœ… **cm-ssh-persistent.py** - Persistent Connection æ·»åŠ  Keep Alive

### é…ç½®å‚æ•°

```
ServerAliveInterval: 60 ç§’
ServerAliveCountMax: 3 æ¬¡
```

### é¢„æœŸæ•ˆæœ

- âœ… è¿æ¥æ›´ç¨³å®š
- âœ… å‡å°‘æ–­çº¿
- âœ… æ›´å¥½ä½“éªŒ
- âœ… å‡ ä¹æ— å¼€é”€

### å…¼å®¹æ€§

âœ… å®Œå…¨å‘åå…¼å®¹  
âœ… ä¸å½±å“ç°æœ‰åŠŸèƒ½  
âœ… ä»…æ”¹è¿›ç¨³å®šæ€§

---

**æ›´æ–°å®Œæˆï¼** ğŸ‰

ä¸‹æ¬¡å¯åŠ¨ SSH session æ—¶ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨æ–°çš„ Keep Alive é…ç½®ã€‚

---

**æ›´æ–°è€…**: OpenClaw Agent  
**å®¡æ ¸è€…**: renhuailu  
**ç‰ˆæœ¬**: v1.1.0 (Keep Alive Support)

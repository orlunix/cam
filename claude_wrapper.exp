#!/usr/bin/expect -f
#
# Coding Agent Wrapper - expect ç‰ˆæœ¬
# è‡ªåŠ¨åŒ– Claude Code çš„äº¤äº’
#
# Usage: ./claude_wrapper.exp "Your task description"

log_user 1
set timeout -1

# æ¸…é™¤ç¯å¢ƒå˜é‡
unset -nocomplain env(ANTHROPIC_AUTH_TOKEN)
unset -nocomplain env(ANTHROPIC_BASE_URL)

# æ—¥å¿—æ–‡ä»¶
set output_file "/tmp/claude-wrapper-[pid].log"
log_file -noappend $output_file

# ä»å‚æ•°è·å–ä»»åŠ¡
if {$argc == 0} {
    puts "Usage: $argv0 <task description>"
    exit 1
}
set task [lindex $argv 0]

puts "ğŸš€ Starting Claude Code with task: $task"
puts "ğŸ“‹ Log file: $output_file"
puts "="

# å¯åŠ¨ Claude Code
spawn claude $task

# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ä¸­æ˜¯å¦æœ‰ç¡®è®¤æç¤º
proc check_for_prompt {filepath} {
    if {![file exists $filepath]} {
        return 0
    }
    
    # æ£€æŸ¥æ˜¯å¦æœ‰ç¡®è®¤æç¤º
    set result [catch {
        exec tail -n 100 $filepath \
            | sed -r {s/\x1B\[[0-9;?]*[ -/]*[@-~]//g} \
            | grep -q {1\..*Yes}
    }]
    
    return [expr {$result == 0}]
}

# æ£€æŸ¥æ˜¯å¦å®Œæˆ
proc check_for_done {filepath} {
    if {![file exists $filepath]} {
        return 0
    }
    
    # æ£€æŸ¥å®Œæˆä¿¡å·
    set result [catch {
        exec tail -n 50 $filepath \
            | sed -r {s/\x1B\[[0-9;?]*[ -/]*[@-~]//g} \
            | grep -q {esc.*interrupt}
    }]
    
    return [expr {$result == 0}]
}

# ä¸»å¾ªç¯
set auto_send_count 0
set last_check_time [clock seconds]

while {1} {
    interact {
        -o
        # ç›´æ¥åŒ¹é…æç¤º
        -re {Do.*you.*want.*to.*proceed} {
            puts "\nâœ… Detected prompt directly"
            send "1"
            incr auto_send_count
        }
        # å®šæœŸæ£€æŸ¥æ—¥å¿—
        timeout 3 {
            set now [clock seconds]
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ç¡®è®¤æç¤º
            if {[check_for_prompt $output_file]} {
                puts "\nâœ… Detected prompt from log (auto-send #$auto_send_count)"
                send "1"
                incr auto_send_count
            }
            
            # æ£€æŸ¥æ˜¯å¦å®Œæˆï¼ˆè¶…è¿‡ 10 ç§’ç©ºé—²ï¼‰
            if {$now - $last_check_time > 10} {
                if {[check_for_done $output_file]} {
                    puts "\nâœ… Task appears complete"
                    break
                }
            }
            
            set last_check_time $now
        }
        eof {
            puts "\nâœ… Process ended"
            break
        }
    }
    
    # è¶…æ—¶ä¿æŠ¤ï¼ˆ5 åˆ†é’Ÿï¼‰
    if {$auto_send_count > 0 && [clock seconds] - $last_check_time > 300} {
        puts "\nâ° Timeout after 5 minutes"
        break
    }
}

puts "\n="
puts "ğŸ“Š Total auto-sends: $auto_send_count"
puts "ğŸ“‹ Full log: $output_file"

# ä¸è¦åˆ é™¤æ—¥å¿—ï¼Œæ–¹ä¾¿æ£€æŸ¥
# file delete -force $output_file

wait

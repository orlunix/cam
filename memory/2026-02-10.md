# 2026-02-10 - Session Memory

## Project: Coding Manager (CM)

### Context
User wants a unified management system for coding tools (Codex, Claude Code, Cursor) that:
- Manages multiple work directories (contexts)
- Tracks all coding sessions with status/events/logs
- Stores everything in Markdown + text files (no database)
- Parses ANSI output from terminal tools
- Auto-confirms prompts
- Provides history and reports

### Key Design Decisions

1. **File Structure**
   - `~/.cm/contexts/*.md` - Work directories (YAML + Markdown)
   - `~/.cm/sessions/active/*.md` - Running sessions
   - `~/.cm/sessions/archive/` - Completed sessions
   - `~/.cm/history/` - Daily reports and by-project summaries

2. **Session Management Strategy**
   - Use OpenClaw's `exec` tool directly (with PTY + background)
   - NOT using isolated sessions for every task (too complex)
   - CM monitors process output via `process log --follow`
   - Parse output ‚Üí detect states ‚Üí update session MD files

3. **Output Parsing**
   - Strip ANSI: `sed 's/\x1b\[[0-9;]*[a-zA-Z]//g'`
   - Or Python script for complex cases
   - Handle carriage returns (\r) for progress bars
   - Regex patterns to detect states: planning/editing/waiting_confirm/done

4. **OpenClaw Architecture Learned**
   - Gateway manages multiple sessions
   - Main session = our conversation
   - Isolated sessions via `sessions_spawn` (for background tasks)
   - Tools: exec, process, sessions_list, sessions_send
   - exec returns process sessionId for monitoring

### Current Status

**‚úÖ Completed:**
- Designed complete spec: `/home/hren/.openclaw/workspace/coding-manager-spec.md`
- Created working prototype: `/home/hren/.openclaw/workspace/cm-prototype/cm`
- Implemented: init, ctx add/list/show, start (session creation)
- Data structure: Markdown + YAML working
- Tested basic workflow

**üöß Next Steps (user will decide):**
- Option A: Complete OpenClaw integration (exec + process monitoring)
- Option B: Finish core commands (status, logs, kill, history)
- Option C: Build daemon for auto-monitoring

### Technical Notes

- User's shell: csh (not bash/zsh)
- User has custom `dl` command: `/home/hren/test/coderepos/dm/dm2parse.sh -list`
- Existing dm2 tool at `/home/hren/test/coderepos/dm/` (directory manager)
- Approval system blocking some commands (workaround: use allowlist)

### User Preferences
- Chinese comfortable, but technical docs in English/Chinese mixed
- Wants text-based storage, no database
- Values git-friendly formats
- Practical, implementation-focused

### Important Context IDs
- User Discord ID: 1105771535958032424
- Main session: agent:main:main
- Workspace: /home/hren/.openclaw/workspace

### Files Created Today
- `/home/hren/.openclaw/workspace/coding-manager-spec.md` - Complete specification (10KB)
- `/home/hren/.openclaw/workspace/cm-prototype/cm` - Executable script (9KB)
- `/home/hren/.openclaw/workspace/cm-prototype/README.md` - Demo documentation
- `~/.cm/` - Data directory structure initialized

### Configuration Changes
- **Discord groupPolicy**: Changed from "allowlist" to "open"
  - Now responds to all Discord servers/channels
  - Config updated via `gateway config.patch`
  
- **AGENTS.md Group Chat Strategy**: Updated to be more responsive
  - Old: "Smart about when to contribute" (conservative)
  - New: "Helpful and responsive" (proactive)
  - **Key change**: Will answer any question in group, not just @mentions
  - Still avoids casual banter and redundant responses

### OpenClaw Sessions Created
1. **Main session** (agent:main:main) - Our primary conversation
2. **#general channel** (Discord server) - Group chat session
3. **test-isolated-session** - Demo of isolated session spawning
4. **codex-demo** - Demo of task delegation to subagent

### Testing & Discoveries

**Exec Approval System:**
- Commands need approval by default
- Allowlist patterns in `~/.openclaw/exec-approvals.json`
- Shell aliases (like `dl`) don't match file path patterns
- Solution: Found `dl` is actually `/home/hren/test/coderepos/dm/dm2parse.sh -list`

**User's Existing Tool (dm2):**
- Directory management system similar to what we're building
- Uses csh, not bash
- Stores contexts/sessions
- Good reference for CM design

**OpenClaw Sessions vs Processes:**
- Isolated sessions = full AI agent instances (expensive)
- exec processes = just shell command execution (lightweight)
- **Decision**: Use exec directly for coding tools, not isolated sessions for each

### Key Learning: Output Parsing Challenge

Terminal output complexity:
- ANSI escape codes (colors, cursor movement)
- Progress bars (carriage return \r)
- Unicode symbols (‚úì ‚úó ‚ö°)
- Real-time streaming

**Solution stack:**
1. Strip ANSI: `sed` or Python regex
2. Handle \r: Take last part after split
3. Pattern matching: Regex for state keywords
4. Stream processing: `process log --follow | parse`

### Session Management Insights

**Tried 3 approaches:**
1. ‚ùå Direct `openclaw exec` calls - can't execute (no CLI access from agent)
2. ‚úÖ Generate task files, let user/system execute
3. ‚úÖ Hybrid: CM creates metadata, OpenClaw agent executes via tools

**Best pattern:**
```
cm start ‚Üí creates session.md + .cmd + .workdir
‚Üí OpenClaw agent reads these
‚Üí Uses exec tool to start
‚Üí Uses process tool to monitor
‚Üí Updates session.md with status
```

### Architecture Clarity Gained

```
User
  ‚Üì
Discord
  ‚Üì
OpenClaw Gateway
  ‚îú‚îÄ‚îÄ Main Session (me, AI agent)
  ‚îÇ     ‚Üì
  ‚îÇ   CM tool (bash script)
  ‚îÇ     ‚Üì
  ‚îÇ   Creates session files
  ‚îÇ     ‚Üì
  ‚îú‚îÄ‚îÄ exec tool ‚Üí Codex/Claude/Cursor (external processes)
  ‚îú‚îÄ‚îÄ process tool ‚Üí monitor output
  ‚îî‚îÄ‚îÄ Isolated sessions (optional, for complex tasks)
```

### Time Spent
- Initial discussion & requirements: ~30 min
- Spec writing: ~20 min
- Prototype implementation: ~30 min
- Testing & iteration: ~20 min
- Configuration & troubleshooting: ~20 min
- Documentation: ~10 min

**Total: ~2.5 hours of productive work**

### User Satisfaction Signals
- ‚úÖ Engaged throughout, asking detailed questions
- ‚úÖ Wanted practical implementation, not just theory
- ‚úÖ Appreciated Markdown-based approach
- ‚úÖ Interested in making bot more responsive in groups
- ‚úÖ Ready to continue development

### Next Session TODO
1. Decide on next phase (A/B/C from above)
2. Implement OpenClaw integration OR
3. Complete remaining cm commands OR
4. Build monitoring daemon
5. Test with real Codex/Claude task

### Meta Notes
- Main session reached 200k token limit (full context window)
- Memory file system working well for persistence
- Good balance of English/Chinese in conversation
- User comfortable with technical deep-dives

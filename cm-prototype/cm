#!/bin/bash
# Coding Manager - ç»Ÿä¸€çš„ç¼–ç å·¥å…·ç®¡ç†ç³»ç»Ÿ
# Version: 0.1.0

set -e

CM_DATA="$HOME/.cm"
CM_BIN="$(dirname "$(readlink -f "$0")")"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# å¸®åŠ©ä¿¡æ¯
show_help() {
    cat <<EOF
Coding Manager (cm) - ç»Ÿä¸€çš„ç¼–ç å·¥å…·ç®¡ç†ç³»ç»Ÿ

ç”¨æ³•:
    cm <command> [options]

Context ç®¡ç†:
    cm ctx add <name> <path> [--tags tag1,tag2]    æ·»åŠ å·¥ä½œç›®å½•
    cm ctx list                                     åˆ—å‡ºæ‰€æœ‰ context
    cm ctx show <name>                              æŸ¥çœ‹ context è¯¦æƒ…
    cm ctx remove <name>                            åˆ é™¤ context

Session ç®¡ç†:
    cm start <tool> "<task>" --ctx <name>          å¯åŠ¨ç¼–ç ä»»åŠ¡
        --full-auto     Codex è‡ªåŠ¨æ‰¹å‡†æ¨¡å¼
        --yolo          Codex æ— æ²™ç®±æ¨¡å¼ï¼ˆæœ€å¿«ï¼‰
        --background    åå°è¿è¡Œï¼ˆé»˜è®¤ï¼‰
    
    cm status [session-id]                          æŸ¥çœ‹çŠ¶æ€
    cm logs <session-id> [--follow]                 æŸ¥çœ‹æ—¥å¿—
    cm input <session-id> "<text>"                  å‘é€è¾“å…¥
    cm kill <session-id>                            ç»ˆæ­¢ä»»åŠ¡

å†å²è®°å½•:
    cm history [--date YYYY-MM-DD] [--ctx name]     æŸ¥çœ‹å†å²
    cm report --ctx <name>                          ç”ŸæˆæŠ¥å‘Š

é…ç½®:
    cm config                                       æŸ¥çœ‹é…ç½®
    cm init                                         åˆå§‹åŒ–ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰

ç¤ºä¾‹:
    cm ctx add myapp ~/Projects/myapp --tags web,api
    cm start codex "æ·»åŠ é”™è¯¯å¤„ç†" --ctx myapp --full-auto
    cm status sess-001
    cm logs sess-001 --follow

EOF
}

# åˆå§‹åŒ–
cm_init() {
    echo "åˆå§‹åŒ– Coding Manager..."
    mkdir -p "$CM_DATA"/{contexts,sessions/{active,archive},history/{by-date,by-context},hooks}
    
    # åˆ›å»ºé»˜è®¤é…ç½®
    if [ ! -f "$CM_DATA/config.json" ]; then
        cat > "$CM_DATA/config.json" <<EOF
{
  "version": 1,
  "defaultTool": "codex",
  "autoConfirm": true,
  "logRetentionDays": 30,
  "tools": {
    "codex": {
      "defaultOptions": ["--full-auto"]
    },
    "claude": {
      "defaultOptions": []
    }
  }
}
EOF
    fi
    
    echo -e "${GREEN}âœ“${NC} åˆå§‹åŒ–å®Œæˆ: $CM_DATA"
}

# Context ç®¡ç†
cm_ctx_add() {
    name=$1
    path=$2
    tags=$3
    
    if [ -z "$name" ] || [ -z "$path" ]; then
        echo -e "${RED}é”™è¯¯:${NC} éœ€è¦ name å’Œ path"
        exit 1
    fi
    
    # å±•å¼€è·¯å¾„
    path=$(eval echo "$path")
    path=$(readlink -f "$path" 2>/dev/null || echo "$path")
    
    if [ ! -d "$path" ]; then
        echo -e "${YELLOW}è­¦å‘Š:${NC} ç›®å½•ä¸å­˜åœ¨: $path"
        read -p "æ˜¯å¦åˆ›å»º? (y/N) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            mkdir -p "$path"
        else
            exit 1
        fi
    fi
    
    timestamp=$(date -Iseconds)
    
    cat > "$CM_DATA/contexts/$name.md" <<EOF
---
name: $name
path: $path
machine: local
created: $timestamp
lastUsed: $timestamp
tags: $tags
---

# Context: $name

**Path:** \`$path\`  
**Machine:** local  
**Created:** $timestamp  
**Tags:** $tags

## Description

$(basename "$path") project workspace.

## Statistics

- Total Sessions: 0
- Success Rate: N/A
- Last 7 Days: 0 sessions

## Recent Sessions

_None yet_

## Notes

Add your notes here.

---

_Last updated: $timestamp_
EOF
    
    echo -e "${GREEN}âœ“${NC} Context å·²æ·»åŠ : $name â†’ $path"
}

cm_ctx_list() {
    echo "Contexts:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    if [ ! -d "$CM_DATA/contexts" ]; then
        echo "  (æœªæ‰¾åˆ° contextsï¼Œè¿è¡Œ 'cm init' åˆå§‹åŒ–)"
        return
    fi
    
    for ctx_file in "$CM_DATA/contexts"/*.md; do
        [ -e "$ctx_file" ] || continue
        
        name=$(basename "$ctx_file" .md)
        
        # æå– YAML front matter
        path=$(awk '/^---$/,/^---$/ {if ($1 == "path:") {$1=""; print; exit}}' "$ctx_file" | xargs)
        tags=$(awk '/^---$/,/^---$/ {if ($1 == "tags:") {$1=""; print; exit}}' "$ctx_file" | xargs)
        lastUsed=$(awk '/^---$/,/^---$/ {if ($1 == "lastUsed:") {$1=""; print; exit}}' "$ctx_file" | xargs)
        
        printf "  ${BLUE}%-15s${NC} %s\n" "$name" "$path"
        if [ -n "$tags" ]; then
            printf "                  Tags: %s\n" "$tags"
        fi
    done
}

cm_ctx_show() {
    name=$1
    ctx_file="$CM_DATA/contexts/$name.md"
    
    if [ ! -f "$ctx_file" ]; then
        echo -e "${RED}é”™è¯¯:${NC} Context ä¸å­˜åœ¨: $name"
        exit 1
    fi
    
    cat "$ctx_file"
}

# Session å¯åŠ¨
cm_start() {
    tool=$1
    task=$2
    ctx_name=""
    tool_opts=""
    
    shift 2
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --ctx)
                ctx_name="$2"
                shift 2
                ;;
            --full-auto)
                tool_opts="$tool_opts --full-auto"
                shift
                ;;
            --yolo)
                tool_opts="$tool_opts --yolo"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    if [ -z "$ctx_name" ]; then
        echo -e "${RED}é”™è¯¯:${NC} éœ€è¦æŒ‡å®š --ctx <name>"
        exit 1
    fi
    
    ctx_file="$CM_DATA/contexts/$ctx_name.md"
    if [ ! -f "$ctx_file" ]; then
        echo -e "${RED}é”™è¯¯:${NC} Context ä¸å­˜åœ¨: $ctx_name"
        exit 1
    fi
    
    # è¯»å– context path
    ctx_path=$(grep "^path:" "$ctx_file" | head -1 | cut -d' ' -f2-)
    
    if [ ! -d "$ctx_path" ]; then
        echo -e "${RED}é”™è¯¯:${NC} ç›®å½•ä¸å­˜åœ¨: $ctx_path"
        exit 1
    fi
    
    # ç”Ÿæˆ session ID
    session_id="sess-$(date +%s)"
    timestamp=$(date -Iseconds)
    
    echo -e "${BLUE}å¯åŠ¨ $tool ä»»åŠ¡:${NC}"
    echo "  Context: $ctx_name ($ctx_path)"
    echo "  Task: $task"
    echo "  Options: $tool_opts"
    echo "  Session: $session_id"
    echo ""
    
    # åˆ›å»º session MD æ–‡ä»¶
    cat > "$CM_DATA/sessions/active/$session_id.md" <<EOF
---
id: $session_id
context: $ctx_name
context_path: $ctx_path
tool: $tool
status: starting
state: initializing
created: $timestamp
updated: $timestamp
process_id: 
auto_confirm: true
---

# Session $session_id

## Task

$task

## Status

ğŸŸ¡ **Starting**

**Duration:** 0s  
**Tool:** $tool $tool_opts  
**Machine:** local

## Timeline

| Time     | Event          | Details                    |
|----------|----------------|----------------------------|
| $(date +%H:%M:%S) | started  | Session created            |

## Files Changed

_None yet_

## Output Highlights

\`\`\`
_Starting..._
\`\`\`

---

_Last updated: $timestamp_
EOF

    # æ„å»ºä¼˜åŒ–çš„ prompt
    enhanced_task=$("$CM_BIN/cm-prompt-builder.sh" "$tool" "$task")
    
    # æ„å»ºå‘½ä»¤ - ä¸åŒå·¥å…·çš„å‘½ä»¤æ ¼å¼
    case "$tool" in
        claude)
            # ä½¿ç”¨ claude-auto åŒ…è£…å™¨ï¼Œè‡ªåŠ¨å¤„ç†æƒé™
            cmd="$CM_BIN/claude-auto.sh '$enhanced_task'"
            ;;
        codex)
            cmd="codex exec $tool_opts '$enhanced_task'"
            ;;
        cursor)
            cmd="cursor '$enhanced_task'"
            ;;
        *)
            cmd="$tool '$enhanced_task'"
            ;;
    esac
    
    echo -e "${YELLOW}è¿è¡Œ:${NC} $cmd"
    echo -e "${YELLOW}å·¥ä½œç›®å½•:${NC} $ctx_path"
    echo ""
    
    # ä¿å­˜å¯åŠ¨ä¿¡æ¯ï¼Œå®é™…æ‰§è¡Œäº¤ç»™ OpenClaw
    echo "$cmd" > "$CM_DATA/sessions/active/$session_id.cmd"
    echo "$ctx_path" > "$CM_DATA/sessions/active/$session_id.workdir"
    
    echo -e "${GREEN}âœ“${NC} Session å·²åˆ›å»º: $session_id"
    echo ""
    echo "ä¸‹ä¸€æ­¥:"
    echo "  1. è®© OpenClaw agent ä½¿ç”¨ exec å·¥å…·å¯åŠ¨è¿™ä¸ªä»»åŠ¡"
    echo "  2. ç›‘æ§ process log"
    echo "  3. è§£æè¾“å‡ºå¹¶æ›´æ–°çŠ¶æ€"
    echo ""
    echo "ç¤ºä¾‹ (éœ€è¦ OpenClaw agent æ‰§è¡Œ):"
    echo "  exec pty:true background:true workdir:\"$ctx_path\" command:\"$cmd\""
}

# Session çŠ¶æ€
cm_status() {
    session_id=$1
    
    if [ -z "$session_id" ]; then
        # åˆ—å‡ºæ‰€æœ‰æ´»åŠ¨ session
        echo "Active Sessions:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        for sess_file in "$CM_DATA/sessions/active"/*.md; do
            [ -e "$sess_file" ] || continue
            
            sid=$(basename "$sess_file" .md)
            status=$(grep "^status:" "$sess_file" | cut -d' ' -f2-)
            tool=$(grep "^tool:" "$sess_file" | cut -d' ' -f2-)
            context=$(grep "^context:" "$sess_file" | cut -d' ' -f2-)
            state=$(grep "^state:" "$sess_file" | cut -d' ' -f2-)
            
            case "$status" in
                running)
                    icon="ğŸŸ¢"
                    ;;
                completed)
                    icon="âœ…"
                    ;;
                failed)
                    icon="âŒ"
                    ;;
                killed)
                    icon="â›”"
                    ;;
                *)
                    icon="ğŸŸ¡"
                    ;;
            esac
            
            printf "  ${icon} %-18s %-8s %-12s %-12s %s\n" "$sid" "$tool" "$context" "$status" "$state"
        done
    else
        # æ˜¾ç¤ºç‰¹å®š session
        sess_file="$CM_DATA/sessions/active/$session_id.md"
        
        if [ ! -f "$sess_file" ]; then
            echo -e "${RED}é”™è¯¯:${NC} Session ä¸å­˜åœ¨: $session_id"
            exit 1
        fi
        
        cat "$sess_file"
    fi
}

# æ‰§è¡Œ session
cm_exec() {
    session_id=$1
    
    if [ -z "$session_id" ]; then
        echo -e "${RED}é”™è¯¯:${NC} éœ€è¦æŒ‡å®š session-id"
        exit 1
    fi
    
    sess_file="$CM_DATA/sessions/active/$session_id.md"
    if [ ! -f "$sess_file" ]; then
        echo -e "${RED}é”™è¯¯:${NC} Session ä¸å­˜åœ¨: $session_id"
        exit 1
    fi
    
    echo -e "${BLUE}æ‰§è¡Œ session: $session_id${NC}"
    
    # è°ƒç”¨ executor
    "$CM_BIN/cm-executor.sh" "$session_id"
}

# æŸ¥çœ‹æ—¥å¿—
cm_logs() {
    session_id=$1
    follow=false
    
    if [ "$2" = "--follow" ] || [ "$2" = "-f" ]; then
        follow=true
    fi
    
    if [ -z "$session_id" ]; then
        echo -e "${RED}é”™è¯¯:${NC} éœ€è¦æŒ‡å®š session-id"
        exit 1
    fi
    
    log_file="$CM_DATA/sessions/active/$session_id.log"
    
    if [ ! -f "$log_file" ]; then
        echo -e "${YELLOW}è­¦å‘Š:${NC} æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $session_id"
        echo "Session å¯èƒ½è¿˜æœªæ‰§è¡Œæˆ–å·²å½’æ¡£"
        exit 1
    fi
    
    if [ "$follow" = true ]; then
        tail -f "$log_file"
    else
        cat "$log_file"
    fi
}

# å‘é€è¾“å…¥
cm_input() {
    session_id=$1
    input=$2
    
    if [ -z "$session_id" ] || [ -z "$input" ]; then
        echo -e "${RED}é”™è¯¯:${NC} éœ€è¦æŒ‡å®š session-id å’Œè¾“å…¥å†…å®¹"
        exit 1
    fi
    
    pid_file="$CM_DATA/sessions/active/$session_id.pid"
    
    if [ ! -f "$pid_file" ]; then
        echo -e "${RED}é”™è¯¯:${NC} Session æœªè¿è¡Œæˆ– PID æ–‡ä»¶ä¸å­˜åœ¨"
        exit 1
    fi
    
    pid=$(cat "$pid_file")
    
    # å‘é€è¾“å…¥åˆ°è¿›ç¨‹ (éœ€è¦ process åœ¨å‰å°æˆ–æœ‰ç®¡é“)
    echo -e "${YELLOW}è­¦å‘Š:${NC} ç›´æ¥å‘é€è¾“å…¥åˆ°è¿›ç¨‹çš„åŠŸèƒ½å°šæœªå®ç°"
    echo "å»ºè®®ä½¿ç”¨ OpenClaw process submit å‘½ä»¤"
}

# ç»ˆæ­¢ session
cm_kill() {
    session_id=$1
    
    if [ -z "$session_id" ]; then
        echo -e "${RED}é”™è¯¯:${NC} éœ€è¦æŒ‡å®š session-id"
        exit 1
    fi
    
    pid_file="$CM_DATA/sessions/active/$session_id.pid"
    sess_file="$CM_DATA/sessions/active/$session_id.md"
    
    if [ ! -f "$sess_file" ]; then
        echo -e "${RED}é”™è¯¯:${NC} Session ä¸å­˜åœ¨: $session_id"
        exit 1
    fi
    
    if [ -f "$pid_file" ]; then
        pid=$(cat "$pid_file")
        echo -e "${YELLOW}ç»ˆæ­¢è¿›ç¨‹ PID: $pid${NC}"
        kill "$pid" 2>/dev/null || echo -e "${YELLOW}è¿›ç¨‹å·²ä¸å­˜åœ¨${NC}"
        rm -f "$pid_file"
    fi
    
    # æ›´æ–°çŠ¶æ€
    sed -i "s/^status:.*/status: killed/" "$sess_file"
    sed -i "s/^updated:.*/updated: $(date -Iseconds)/" "$sess_file"
    
    echo -e "${GREEN}âœ“${NC} Session å·²ç»ˆæ­¢: $session_id"
}

# ä¸»å…¥å£
main() {
    # ç¡®ä¿åˆå§‹åŒ–
    if [ ! -d "$CM_DATA" ] && [ "$1" != "init" ] && [ "$1" != "help" ]; then
        echo -e "${YELLOW}é¦–æ¬¡è¿è¡Œï¼Œæ­£åœ¨åˆå§‹åŒ–...${NC}"
        cm_init
        echo ""
    fi
    
    case "$1" in
        init)
            cm_init
            ;;
        ctx)
            case "$2" in
                add)
                    cm_ctx_add "$3" "$4" "$5"
                    ;;
                list|ls)
                    cm_ctx_list
                    ;;
                show)
                    cm_ctx_show "$3"
                    ;;
                *)
                    echo "ç”¨æ³•: cm ctx {add|list|show}"
                    exit 1
                    ;;
            esac
            ;;
        start)
            cm_start "$2" "$3" "${@:4}"
            ;;
        exec)
            cm_exec "$2"
            ;;
        status)
            cm_status "$2"
            ;;
        logs)
            cm_logs "$2" "$3"
            ;;
        input)
            cm_input "$2" "$3"
            ;;
        kill)
            cm_kill "$2"
            ;;
        extract)
            "$CM_BIN/cm-extract-code.sh" "$2"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            show_help
            exit 1
            ;;
    esac
}

main "$@"

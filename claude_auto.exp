#!/usr/bin/expect -f
#
# Coding Agent Wrapper - Production Version
# 
# Usage: ./claude_auto.exp <workdir> <task>
#
# Example:
#   ./claude_auto.exp /tmp/myproject "Create a REST API"

log_user 1
set timeout -1

if {$argc < 2} {
    puts "Usage: $argv0 <workdir> <task>"
    puts ""
    puts "Example:"
    puts "  $argv0 /tmp/project \"Create hello.py with print('Hi')\""
    exit 1
}

set workdir [lindex $argv 0]
set task [lindex $argv 1]

# æ£€æŸ¥ç›®å½•
if {![file isdirectory $workdir]} {
    puts "Error: $workdir is not a directory"
    exit 1
}

# æ—¥å¿—æ–‡ä»¶
set timestamp [clock format [clock seconds] -format "%Y%m%d-%H%M%S"]
set output_file "$workdir/.claude-wrapper-$timestamp.log"
log_file -noappend $output_file

puts "ğŸš€ Coding Agent Wrapper"
puts "="
puts "ğŸ“ Workdir: $workdir"
puts "ğŸ“ Task: $task"
puts "ğŸ“‹ Log: $output_file"
puts "="

cd $workdir

# å¯åŠ¨ Claude Code
spawn claude $task

# æ£€æŸ¥ç¡®è®¤æç¤º
proc check_for_prompt {filepath} {
    if {![file exists $filepath]} {
        return 0
    }
    
    set result [catch {
        exec tail -n 100 $filepath \
            | sed -r {s/\x1B\[[0-9;?]*[ -/]*[@-~]//g} \
            | egrep -q {(1\..*Yes|Do.*you.*want|Permission.*requires)}
    }]
    
    return [expr {$result == 0}]
}

# æ£€æŸ¥å®Œæˆ
proc check_for_done {filepath} {
    if {![file exists $filepath]} {
        return 0
    }
    
    set result [catch {
        exec tail -n 50 $filepath \
            | sed -r {s/\x1B\[[0-9;?]*[ -/]*[@-~]//g} \
            | grep -q {(esc.*interrupt|\? for shortcuts)}
    }]
    
    return [expr {$result == 0}]
}

# ä¸»å¾ªç¯
set auto_confirm_count 0
set idle_count 0
set max_idle 20

while {1} {
    interact {
        -o
        timeout 3 {
            # æ£€æŸ¥ç¡®è®¤æç¤º
            if {[check_for_prompt $output_file]} {
                if {$auto_confirm_count < 50} {
                    send "1"
                    incr auto_confirm_count
                    puts "\nâœ… Auto-confirmed (#$auto_confirm_count)"
                    set idle_count 0
                } else {
                    puts "\nâš ï¸ Too many confirmations, stopping"
                    break
                }
            } else {
                incr idle_count
                
                # æ£€æŸ¥æ˜¯å¦å®Œæˆ
                if {$idle_count > 3 && [check_for_done $output_file]} {
                    puts "\nâœ… Task completed!"
                    break
                }
                
                # è¶…æ—¶ä¿æŠ¤
                if {$idle_count > $max_idle} {
                    puts "\nâ° Idle timeout (${idle_count}x3 = [expr {$idle_count * 3}] seconds)"
                    break
                }
            }
        }
        eof {
            puts "\nâœ… Process ended"
            break
        }
    }
}

puts "="
puts "ğŸ“Š Statistics:"
puts "  - Auto-confirmations: $auto_confirm_count"
puts "  - Idle cycles: $idle_count"
puts "ğŸ“‹ Full log: $output_file"
puts "="

wait

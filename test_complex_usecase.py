#!/usr/bin/env python3
"""
å¤æ‚ç”¨ä¾‹æµ‹è¯• - æ„å»ºä¸€ä¸ªå®Œæ•´çš„ Flask TODO API

è¿™ä¸ªæµ‹è¯•ä¼šåˆ›å»ºä¸€ä¸ªå¤šæ–‡ä»¶çš„é¡¹ç›®ï¼š
1. models.py - æ•°æ®æ¨¡å‹
2. api.py - Flask API endpoints
3. utils.py - è¾…åŠ©å‡½æ•°
4. test_api.py - å•å…ƒæµ‹è¯•
"""

import sys
import os
import subprocess
import tempfile

sys.path.insert(0, os.path.dirname(__file__))
from coding_agent_api import CodingAgentAPI, execute_tasks


def setup_project():
    """åˆ›å»ºæµ‹è¯•é¡¹ç›®"""
    project_dir = tempfile.mkdtemp(prefix="flask-todo-")
    
    print(f"ğŸ“ Creating project: {project_dir}")
    
    # åˆå§‹åŒ– git
    subprocess.run(["git", "init"], cwd=project_dir, capture_output=True)
    subprocess.run(["git", "config", "user.email", "test@test.com"], cwd=project_dir, capture_output=True)
    subprocess.run(["git", "config", "user.name", "Test"], cwd=project_dir, capture_output=True)
    
    # åˆ›å»º README
    readme = os.path.join(project_dir, "README.md")
    with open(readme, 'w') as f:
        f.write("# Flask TODO API\n\nAutomatically generated by Coding Agent\n")
    
    subprocess.run(["git", "add", "README.md"], cwd=project_dir, capture_output=True)
    subprocess.run(["git", "commit", "-m", "Initial commit"], cwd=project_dir, capture_output=True)
    
    return project_dir


def test_complex_project():
    """æµ‹è¯•å¤æ‚é¡¹ç›®"""
    
    print("ğŸš€ Complex Use Case: Flask TODO API")
    print("=" * 60)
    
    # è®¾ç½®é¡¹ç›®
    project_dir = setup_project()
    print(f"âœ… Project initialized at: {project_dir}")
    print()
    
    # å®šä¹‰ä»»åŠ¡åºåˆ—
    tasks = [
        # Task 1: æ•°æ®æ¨¡å‹
        """Create models.py with a Todo class that has:
        - id (int)
        - title (string)
        - completed (boolean)
        - created_at (datetime)
        Include a to_dict() method""",
        
        # Task 2: Flask API
        """Create api.py with Flask REST API:
        - GET /todos - list all todos
        - POST /todos - create new todo
        - PUT /todos/<id> - update todo
        - DELETE /todos/<id> - delete todo
        Use in-memory storage (list)""",
        
        # Task 3: è¾…åŠ©å‡½æ•°
        """Create utils.py with helper functions:
        - validate_todo(data) - validate todo data
        - format_response(data, status) - format JSON response""",
    ]
    
    # æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡
    print(f"ğŸ“ Executing {len(tasks)} tasks...")
    print()
    
    results = execute_tasks(
        tasks=tasks,
        workdir=project_dir,
        debug=True,
        timeout=300  # æ¯ä¸ªä»»åŠ¡æœ€å¤š5åˆ†é’Ÿ
    )
    
    # ç»Ÿè®¡ç»“æœ
    print("\n" + "=" * 60)
    print("ğŸ“Š FINAL RESULTS")
    print("=" * 60)
    
    total_duration = sum(r.duration for r in results)
    total_confirms = sum(r.auto_confirms for r in results)
    total_files = sum(len(r.files_created) for r in results)
    
    print(f"\nâœ… Completed: {len([r for r in results if r.success])}/{len(tasks)} tasks")
    print(f"â±ï¸  Total duration: {total_duration:.1f}s")
    print(f"ğŸ”„ Total auto-confirms: {total_confirms}")
    print(f"ğŸ“„ Total files created: {total_files}")
    
    # åˆ—å‡ºæ‰€æœ‰åˆ›å»ºçš„æ–‡ä»¶
    print(f"\nğŸ“‚ Project structure:")
    for result in results:
        for filename in result.files_created:
            filepath = os.path.join(project_dir, filename)
            if os.path.exists(filepath):
                size = os.path.getsize(filepath)
                print(f"  âœ… {filename} ({size} bytes)")
    
    # æ˜¾ç¤ºæ–‡ä»¶å†…å®¹
    print(f"\nğŸ“„ File contents:")
    for result in results:
        for filename in result.files_created:
            filepath = os.path.join(project_dir, filename)
            if os.path.exists(filepath):
                print(f"\n{'-' * 60}")
                print(f"FILE: {filename}")
                print('-' * 60)
                with open(filepath, 'r') as f:
                    content = f.read()
                    # åªæ˜¾ç¤ºå‰30è¡Œ
                    lines = content.split('\n')
                    if len(lines) > 30:
                        print('\n'.join(lines[:30]))
                        print(f"\n... ({len(lines) - 30} more lines)")
                    else:
                        print(content)
    
    print(f"\n{'=' * 60}")
    print(f"ğŸ’¡ Project preserved at: {project_dir}")
    print(f"{'=' * 60}")
    
    # è¿”å›ç»“æœ
    return {
        'success': all(r.success for r in results),
        'project_dir': project_dir,
        'results': results,
        'total_duration': total_duration,
        'total_files': total_files,
    }


if __name__ == "__main__":
    result = test_complex_project()
    
    if result['success']:
        print("\nâœ… All tasks completed successfully!")
        sys.exit(0)
    else:
        print("\nâŒ Some tasks failed")
        sys.exit(1)
